<!-- Results partial â€” loaded via HTMX into #results-section -->
<div class="h-full flex flex-col fade-in">

    <!-- Stats bar -->
    <div class="bg-gray-800/80 border-b border-gray-700 px-6 py-2 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-1.5 text-sm">
            <!-- Filter buttons -->
            <button @click="$dispatch('set-filter', 'all')"
                    class="px-3 py-1 rounded-full text-xs font-medium transition-colors"
                    :class="(typeof activeFilter !== 'undefined' ? activeFilter : 'all') === 'all'
                        ? 'bg-white/15 text-white'
                        : 'text-gray-400 hover:bg-white/5 hover:text-gray-300'">
                <span class="font-semibold">{{ total_images }}</span> all
            </button>
            <button @click="$dispatch('set-filter', 'selected')"
                    class="px-3 py-1 rounded-full text-xs font-medium transition-colors"
                    :class="(typeof activeFilter !== 'undefined' ? activeFilter : 'all') === 'selected'
                        ? 'bg-green-500/20 text-green-300'
                        : 'text-gray-400 hover:bg-green-500/10 hover:text-green-400'">
                <span class="font-semibold" id="stats-selected">{{ total_selected }}</span> selected
            </button>
            <button @click="$dispatch('set-filter', 'scored')"
                    class="px-3 py-1 rounded-full text-xs font-medium transition-colors"
                    :class="(typeof activeFilter !== 'undefined' ? activeFilter : 'all') === 'scored'
                        ? 'bg-indigo-500/20 text-indigo-300'
                        : 'text-gray-400 hover:bg-indigo-500/10 hover:text-indigo-400'">
                <span class="font-semibold">{{ total_images - total_selected - total_rejected }}</span> scored
            </button>
            <button @click="$dispatch('set-filter', 'rejected')"
                    class="px-3 py-1 rounded-full text-xs font-medium transition-colors"
                    :class="(typeof activeFilter !== 'undefined' ? activeFilter : 'all') === 'rejected'
                        ? 'bg-red-500/20 text-red-300'
                        : 'text-gray-400 hover:bg-red-500/10 hover:text-red-400'">
                <span class="font-semibold">{{ total_rejected }}</span> rejected
            </button>
            <span class="text-gray-500 text-xs ml-2">
                <span class="text-indigo-400 font-semibold">{{ elapsed }}s</span>
            </span>
        </div>
        <div class="flex items-center">
            <!-- Button group: Export | Export & Download -->
            <div class="inline-flex rounded-lg overflow-hidden border border-indigo-500/30">
                <button hx-post="/api/jobs/{{ job_id }}/export"
                        hx-target="#toast-container"
                        hx-swap="innerHTML"
                        class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium
                               transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M5 13l4 4L19 7" />
                    </svg>
                    Export (<span id="export-count">{{ total_selected }}</span>)
                </button>
                <div class="w-px bg-indigo-400/30"></div>
                <button @click="
                            $el.disabled = true;
                            $el.querySelector('.dl-icon').classList.add('hidden');
                            $el.querySelector('.dl-spin').classList.remove('hidden');
                            fetch('/api/jobs/{{ job_id }}/export-download', {method: 'POST'})
                                .then(r => {
                                    if (!r.ok) throw new Error('Export failed');
                                    return r.blob();
                                })
                                .then(blob => {
                                    const a = document.createElement('a');
                                    a.href = URL.createObjectURL(blob);
                                    a.download = 'character-sniper-results-{{ job_id }}.zip';
                                    a.click();
                                    URL.revokeObjectURL(a.href);
                                })
                                .catch(e => console.error(e))
                                .finally(() => {
                                    $el.disabled = false;
                                    $el.querySelector('.dl-icon').classList.remove('hidden');
                                    $el.querySelector('.dl-spin').classList.add('hidden');
                                });
                        "
                        class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium
                               transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-wait">
                    <svg class="w-4 h-4 dl-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <div class="w-4 h-4 dl-spin hidden animate-spin border-2 border-white border-t-transparent rounded-full"></div>
                    Export &amp; Download
                </button>
            </div>
        </div>
    </div>

    <!-- Main area: folder tabs + gallery -->
    <div class="flex-1 grid grid-cols-[auto_1fr] min-h-0 overflow-hidden">

        {% if folder_names | length > 1 %}
        <!-- Folder sidebar - sticky -->
        <div class="w-56 bg-gray-800/50 border-r border-gray-700 overflow-y-auto"
             x-data="{ activeFolder: '{{ folder_names[0] }}' }">
            <div class="p-3">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Folders</h3>
                {% for fname in folder_names %}
                {% set folder_images = results[fname] %}
                {% set sel_count = folder_images | selectattr("selected") | list | length %}
                <button @click="activeFolder = '{{ fname }}';
                                document.querySelectorAll('.folder-panel').forEach(el => el.classList.add('hidden'));
                                document.getElementById('folder-{{ fname | url_folder | replace('/', '__') }}').classList.remove('hidden');"
                         class="w-full text-left px-3 py-2 rounded-lg text-sm mb-1 transition-colors"
                         :class="activeFolder === '{{ fname }}'
                             ? 'bg-indigo-500/20 text-indigo-300'
                             : 'text-gray-400 hover:bg-gray-700/50 hover:text-gray-300'">
                    <div class="flex items-center justify-between">
                        <span class="truncate">{{ fname }}</span>
                        <span id="folder-count-{{ fname | url_folder | replace('/', '__') }}"
                              class="text-xs px-1.5 py-0.5 rounded-full"
                              :class="activeFolder === '{{ fname }}'
                                  ? 'bg-indigo-500/30 text-indigo-300'
                                  : 'bg-gray-700 text-gray-500'"
                              data-folder-total="{{ folder_images | length }}">
                            {{ sel_count }}/{{ folder_images | length }}
                        </span>
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Gallery panels -->
        <div class="overflow-y-auto p-4 min-h-0">
            {% for fname in folder_names %}
            <div id="folder-{{ fname | url_folder | replace('/', '__') }}"
                 class="folder-panel {% if not loop.first and folder_names | length > 1 %}hidden{% endif %}">

                {% if folder_names | length == 1 and not is_recursive %}
                <h3 class="text-sm text-gray-500 mb-4">All images</h3>
                {% endif %}

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    {% for img in results[fname] %}
                    {% set selected = img.selected %}
                    {% set border = "border-indigo-500 ring-2 ring-indigo-500/50" if selected else "border-gray-700" %}
                    {% set uf = fname | url_folder %}
                    {% set safe_folder = uf | replace("/", "__") %}
                    {% set safe_filename = img.filename | replace(".", "_") %}
                    {% if selected %}{% set status = "selected" %}{% elif img.reject_reason %}{% set status = "rejected" %}{% else %}{% set status = "scored" %}{% endif %}

                    <div id="card-{{ safe_folder }}-{{ safe_filename }}"
                         class="relative rounded-lg overflow-hidden border-2 {{ border }} bg-gray-800 transition-all duration-200 group"
                         data-compare-src="/images/{{ job_id }}/{{ uf }}/{{ img.filename }}"
                         data-compare-filename="{{ img.filename }}"
                         data-compare-face="{{ img.face_score }}"
                         data-compare-clip="{{ img.clip_score }}"
                         data-compare-final="{{ img.final_score }}"
                         data-compare-folder="{{ fname }}"
                         data-status="{{ status }}"
                    >
                        <!-- Image -->
                        <div class="aspect-[3/4] overflow-hidden bg-gray-900">
                            <img src="/images/{{ job_id }}/{{ uf }}/{{ img.filename }}"
                                 alt="{{ img.filename }}"
                                 class="w-full h-full object-cover"
                                 loading="lazy" />
                        </div>

                        <!-- Scores -->
                        <div class="p-2 space-y-1.5">
                            <div class="flex items-center justify-between gap-1">
                                {% if img.final_score is not none %}
                                <span class="px-2 py-0.5 rounded-full text-xs font-bold bg-indigo-500/30 text-indigo-300">{{ "%.3f" | format(img.final_score) }}</span>
                                <span class="text-[10px] text-gray-500">F:{{ "%.3f" | format(img.face_score) }} C:{{ "%.3f" | format(img.clip_score) }}</span>
                                {% elif img.reject_reason %}
                                <span class="px-2 py-0.5 rounded-full text-xs bg-red-500/20 text-red-400">{{ img.reject_reason }}</span>
                                {% else %}
                                <span class="px-2 py-0.5 rounded-full text-xs bg-gray-600 text-gray-400">N/A</span>
                                {% endif %}
                            </div>
                            <p class="text-[10px] text-gray-500 truncate" title="{{ img.filename }}">{{ img.filename }}</p>

                            <!-- Action buttons -->
                            <div class="flex items-center gap-1.5 pt-0.5">
                                {% if selected %}
                                <button hx-post="/api/jobs/{{ job_id }}/toggle/{{ uf }}/{{ img.filename }}"
                                        hx-target="#card-{{ safe_folder }}-{{ safe_filename }}"
                                        hx-swap="outerHTML"
                                        class="flex-1 px-2 py-1 rounded text-[11px] font-medium transition-colors
                                               bg-red-500/20 text-red-400 hover:bg-red-500/30"
                                        title="Remove from selection">
                                    Deselect
                                </button>
                                {% else %}
                                <button hx-post="/api/jobs/{{ job_id }}/toggle/{{ uf }}/{{ img.filename }}"
                                        hx-target="#card-{{ safe_folder }}-{{ safe_filename }}"
                                        hx-swap="outerHTML"
                                        class="flex-1 px-2 py-1 rounded text-[11px] font-medium transition-colors
                                               bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30"
                                        title="Add to selection">
                                    Select
                                </button>
                                {% endif %}
                                <button @click="$dispatch('compare-image', {
                                            src: '/images/{{ job_id }}/{{ uf }}/{{ img.filename }}',
                                            filename: '{{ img.filename }}',
                                            folder: '{{ fname }}',
                                            face_score: '{{ img.face_score }}',
                                            clip_score: '{{ img.clip_score }}',
                                            final_score: '{{ img.final_score }}',
                                            cardId: 'card-{{ safe_folder }}-{{ safe_filename }}'
                                        })"
                                        class="px-2 py-1 rounded text-[11px] font-medium transition-colors
                                               bg-gray-700 text-gray-300 hover:bg-gray-600"
                                        title="Compare with original">
                                    Compare
                                </button>
                            </div>
                        </div>

                        <!-- Selection badge -->
                        {% if selected %}
                        <div class="absolute top-2 right-2 bg-indigo-500 rounded-full p-1">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
